---
title: Query Index Performance
author: Iulian
type: post
date: 2016-01-20T09:26:17+00:00
url: /2016/01/query-index-performance/
categories:
  - NoSQL
tags:
  - mongodb

---
## Query index performance

<p style="text-align: justify;">
  Indexes dramatically improve the speed and the efficient resolution of read operations. Without indexes, MongoDB must scan every document of a collection to select those documents that match the query statement. This scan is highly inefficient and require the MongoDB to process a large volume of data.
</p>

Indexes store a small portion of the data set in an easy to traverse form. The index stores the value of a specific field or set of fields, ordered by the value of the field as specified in index.

<p style="text-align: justify;">
  <strong>CreateIndex command &#8211;</strong> is very similar to sort command (1 = ascending, -1 = descending). <strong><a href="https://docs.mongodb.org/manual/core/index-compound/" target="_blank">Compound index</a></strong> has multiple fields in it&#8217;s definition. You can index array contents, subdocuments and subfields.
</p>

<pre class="lang:js decode:true">db.studentsInfoCollection.createIndex({"name.firstName":1})
db.studentsInfoCollection.createIndex({"student_id":1}, {unique:true}) -- unique index, prevent duplicate key insert</pre>

<p style="text-align: justify;">
  Optional you can specify the name of the index. If unspecified, MongoDB generates an index name by concatenating the names of the indexed fields and the sort order.
</p>

<p style="text-align: justify;">
  If the field does not exists in any of the documents from the collection, MongoDB will create the index without any warning. A MongoDB index can have keys of different types (i.e., ints, dates, string).
</p>

Retrieve the list of indexes for a collection:

<pre class="lang:js decode:true">db.studentsInfoCollection.getIndexes();</pre>

<pre class="lang:js decode:true ">[
        {
                "v" : 1,
                "key" : {
                        "_id" : 1
                },
                "name" : "_id_",
                "ns" : "students.studentsInfoCollection"
        },
        {
                "v" : 1,
                "key" : {
                        "name.firstName" : 1
                },
                "name" : "name.firstName_1",
                "ns" : "students.studentsInfoCollection"
        }
]</pre>

**Delete an index:**

<pre class="lang:js decode:true">db.studentsInfoCollection.dropIndex({"name.firstName":1}); -- the same format as creation
db.studentsInfoCollection.dropIndex("name.firstName_1") -- drop the index specified by name</pre>

<p style="text-align: justify;">
  <strong>ObjectID</strong> &#8211; unique, autogenerated (unless specified), 12 bytes, it provides valuable information about the document: eg. when was created:
</p>

<pre class="lang:js decode:true ">db.studentsInfoCollection.find()[0]._id.getTimestamp();</pre>

<h2 style="text-align: justify;">
  Explain queries:
</h2>

<p style="text-align: justify;">
  MongoDB allow to examine queries and see what indexes are used and figure out the performance of the query statement.
</p>

<strong style="text-align: justify;">$explain</strong>

<pre class="lang:js decode:true">db.studentsInfoCollection.find({"name.firstName":"Doina"}).explain("executionStats");</pre>

<pre class="lang:batch decode:true">"executionStats" : {
                "executionSuccess" : true,
                "nReturned" : 1,
                "executionTimeMillis" : 1,
                "totalKeysExamined" : 1,
                "totalDocsExamined" : 1,
                "executionStages" : {</pre>

<ul class="list">
  <li>
    <b>nReturned</b> &#8211; indicates the number of documents matching returned
  </li>
  <li>
    <b>nscannedObjects</b> indicates the total number of documents scanned
  </li>
  <li>
    <b>nscanned</b> indicates the total number of documents or index entries scanned
  </li>
</ul>

<pre class="lang:js decode:true">db.studentsInfoCollection.find({"name.lastName":"Tabara"}).explain("executionStats");</pre>

<pre class="lang:batch decode:true ">"executionStats" : {
                "executionSuccess" : true,
                "nReturned" : 2,
                "executionTimeMillis" : 0,
                "totalKeysExamined" : 0,
                "totalDocsExamined" : 2,
                "executionStages" : {
                        "stage" : "COLLSCAN",
                        "filter" : {
                                "name.lastName" : {
                                        "$eq" : "Tabara"
                                }
                        },
                        "nReturned" : 2,
                        "executionTimeMillisEstimate" : 0,
                        "works" : 4,
                        "advanced" : 2,
                        "needTime" : 1,
                        "needFetch" : 0,
                        "saveState" : 0,
                        "restoreState" : 0,
                        "isEOF" : 1,
                        "invalidates" : 0,
                        "direction" : "forward",
                        "docsExamined" : 2
                }
        }</pre>

<p style="text-align: justify;">
  We look for <em>totalKeysExamined</em> = 0 (no index yet) and <em>totalDocsExamined</em> = 2 and <em>nReturnedÂ </em> = 2.
</p>

<p style="text-align: justify;">
  Another example, this time using 1.000.000 documents.
</p>

<pre class="lang:js decode:true">// inserts 100x100x100 records into mycoll collection.
// { "_id" : 0, "a" : 0, "b" : 0, "c" : 0 }
// { "_id" : 1, "a" : 0, "b" : 0, "c" : 1 }
// { "_id" : 2, "a" : 0, "b" : 0, "c" : 2 }

for (i=0; i&lt;100; i++){
  for (j=0; j&lt;100; j++){
    x = [];
    for (k=0; k&lt;100; k++){
      x.push({a:i, b:j, c:k, _id:(100*100*i + 100*j + k)});
    }
    db.mycoll.insert(x);
  }
}

 db.mycoll.createIndex({a:1, b:1})
 db.mycoll.createIndex({b:1})
 
 db.mycoll.explain().find({a:17}).sort({b:-1})
 // we look for winningPlan, indexName and direction</pre>

and output:

<pre class="lang:js decode:true ">{
        "queryPlanner" : {
                "plannerVersion" : 1,
                "namespace" : "example.mycoll",
                "indexFilterSet" : false,
                "parsedQuery" : {
                        "a" : {
                                "$eq" : 17
                        }
                },
                "winningPlan" : {
                        "stage" : "FETCH",
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "keyPattern" : {
                                        "a" : 1,
                                        "b" : 1
                                },
                                "indexName" : "a_1_b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "backward",
                                "indexBounds" : {
                                        "a" : [
                                                "[17.0, 17.0]"
                                        ],
                                        "b" : [
                                                "[MaxKey, MinKey]"
                                        ]
                                }
                        }
                },
                "rejectedPlans" : [ ]
        },
        "serverInfo" : {
                "host" : "BLUEONE",
                "port" : 27017,
                "version" : "3.2.0",
                "gitVersion" : "45d947729a0315accb6d4f15a6b06be6d9c19fe7"
        },
        "ok" : 1
}
&gt;</pre>

Collection scan (COLLSCAN) occurs when indexes are not involved:

<pre class="lang:js decode:true">&gt; db.mycoll.explain().find({c:25})
{
        "queryPlanner" : {
                "plannerVersion" : 1,
                "namespace" : "example.mycoll",
                "indexFilterSet" : false,
                "parsedQuery" : {
                        "c" : {
                                "$eq" : 25
                        }
                },
                "winningPlan" : {
                        "stage" : "COLLSCAN",
                        "filter" : {
                                "c" : {
                                        "$eq" : 25
                                }
                        },
                        "direction" : "forward"
                },
                "rejectedPlans" : [ ]
        },
        "serverInfo" : {
                "host" : "BLUEONE",
                "port" : 27017,
                "version" : "3.2.0",
                "gitVersion" : "45d947729a0315accb6d4f15a6b06be6d9c19fe7"
        },
        "ok" : 1
}</pre>

<p style="text-align: justify;">
  $explain allows you to evaluate the write operations. When applying it<strong> does not perform the operations</strong> but it estimates the time required to perform it and figure out what indexes are used.
</p>

<pre class="lang:js decode:true ">db.mycoll.find({a:17, b:12}).count()
db.mycoll.explain().remove({a:17, b:12})</pre>

Output:

<pre class="lang:js decode:true ">{
        "queryPlanner" : {
                "plannerVersion" : 1,
                "namespace" : "example.mycoll",
                "indexFilterSet" : false,
                "parsedQuery" : {
                        "$and" : [
                                {
                                        "a" : {
                                                "$eq" : 17
                                        }
                                },
                                {
                                        "b" : {
                                                "$eq" : 12
                                        }
                                }
                        ]
                },
                "winningPlan" : {
                        "stage" : "FETCH",
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "keyPattern" : {
                                        "a" : 1,
                                        "b" : 1
                                },
                                "indexName" : "a_1_b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "a" : [
                                                "[17.0, 17.0]"
                                        ],
                                        "b" : [
                                                "[12.0, 12.0]"
                                        ]
                                }
                        }
                },
                "rejectedPlans" : [
                        {
                                "stage" : "FETCH",
                                "filter" : {
                                        "a" : {
                                                "$eq" : 17
                                        }
                                },
                                "inputStage" : {
                                        "stage" : "IXSCAN",
                                        "keyPattern" : {
                                                "b" : 1
                                        },
                                        "indexName" : "b_1",
                                        "isMultiKey" : false,
                                        "isUnique" : false,
                                        "isSparse" : false,
                                        "isPartial" : false,
                                        "indexVersion" : 1,
                                        "direction" : "forward",
                                        "indexBounds" : {
                                                "b" : [
                                                        "[12.0, 12.0]"
                                                ]
                                        }
                                }
                        }
                ]
        },
        "serverInfo" : {
                "host" : "BLUEONE",
                "port" : 27017,
                "version" : "3.2.0",
                "gitVersion" : "45d947729a0315accb6d4f15a6b06be6d9c19fe7"
        },
        "ok" : 1
}</pre>

## queryPlanner vs executionStats vs <tt class="docutils literal"><span class="pre">allPlansExecution</span></tt>

<p style="text-align: justify;">
  The behavior of <tt class="xref mongodb mongodb-method docutils literal"><span class="pre">db.collection.explain()</span></tt> and the amount of information returned depend on the <tt class="docutils literal"><span class="pre">verbosity</span></tt> mode. The default mode for $explain is <a href="https://docs.mongodb.org/manual/reference/method/db.collection.explain/#db.collection.explain" target="_blank">queryPlanner</a>.
</p>

<p style="text-align: justify;">
  <strong>executionStats</strong> includes <strong>queryPlanner</strong> and additional information:
</p>

<li style="text-align: justify;">
  time to execute the query
</li>
<li style="text-align: justify;">
  number of documents returned
</li>
<li style="text-align: justify;">
  documents examined.
</li>

<pre class="lang:js decode:true ">exp = db.mycoll.explain("executionStats")
exp.find({a:17, b:55})
</pre>

The output:

<pre class="lang:js decode:true">{
        "queryPlanner" : {
                "plannerVersion" : 1,
                "namespace" : "example.mycoll",
                "indexFilterSet" : false,
                "parsedQuery" : {
                        "$and" : [
                                {
                                        "a" : {
                                                "$eq" : 17
                                        }
                                },
                                {
                                        "b" : {
                                                "$eq" : 55
                                        }
                                }
                        ]
                },
                "winningPlan" : {
                        "stage" : "FETCH",
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "keyPattern" : {
                                        "a" : 1,
                                        "b" : 1
                                },
                                "indexName" : "a_1_b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "a" : [
                                                "[17.0, 17.0]"
                                        ],
                                        "b" : [
                                                "[55.0, 55.0]"
                                        ]
                                }
                        }
                },
                "rejectedPlans" : [
                        {
                                "stage" : "FETCH",
                                "filter" : {
                                        "a" : {
                                                "$eq" : 17
                                        }
                                },
                                "inputStage" : {
                                        "stage" : "IXSCAN",
                                        "keyPattern" : {
                                                "b" : 1
                                        },
                                        "indexName" : "b_1",
                                        "isMultiKey" : false,
                                        "isUnique" : false,
                                        "isSparse" : false,
                                        "isPartial" : false,
                                        "indexVersion" : 1,
                                        "direction" : "forward",
                                        "indexBounds" : {
                                                "b" : [
                                                        "[55.0, 55.0]"
                                                ]
                                        }
                                }
                        }
                ]
        },
        "executionStats" : {
                "executionSuccess" : true,
                "nReturned" : 100,
                "executionTimeMillis" : 8,
                "totalKeysExamined" : 100,
                "totalDocsExamined" : 100,
                "executionStages" : {
                        "stage" : "FETCH",
                        "nReturned" : 100,
                        "executionTimeMillisEstimate" : 0,
                        "works" : 102,
                        "advanced" : 100,
                        "needTime" : 0,
                        "needYield" : 0,
                        "saveState" : 2,
                        "restoreState" : 2,
                        "isEOF" : 1,
                        "invalidates" : 0,
                        "docsExamined" : 100,
                        "alreadyHasObj" : 0,
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "nReturned" : 100,
                                "executionTimeMillisEstimate" : 0,
                                "works" : 101,
                                "advanced" : 100,
                                "needTime" : 0,
                                "needYield" : 0,
                                "saveState" : 2,
                                "restoreState" : 2,
                                "isEOF" : 1,
                                "invalidates" : 0,
                                "keyPattern" : {
                                        "a" : 1,
                                        "b" : 1
                                },
                                "indexName" : "a_1_b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "a" : [
                                                "[17.0, 17.0]"
                                        ],
                                        "b" : [
                                                "[55.0, 55.0]"
                                        ]
                                },
                                "keysExamined" : 100,
                                "dupsTested" : 0,
                                "dupsDropped" : 0,
                                "seenInvalidated" : 0
                        }
                }
        },
        "serverInfo" : {
                "host" : "BLUEONE",
                "port" : 27017,
                "version" : "3.2.0",
                "gitVersion" : "45d947729a0315accb6d4f15a6b06be6d9c19fe7"
        },
        "ok" : 1
}</pre>

<p style="text-align: justify;">
  MongoDB runs the <a class="reference internal" href="https://docs.mongodb.org/manual/core/query-plans/"><em>query optimizer</em></a> to choose the winning plan, executes the winning plan to completion, and returns statistics describing the execution of the winning plan.
</p>

<p style="text-align: justify;">
  If we drop the index and rerun the statement the output will change:
</p>

<pre class="lang:js decode:true ">db.mycoll.dropIndex({a:1, b:1})
exp.find({a:17, b:55})
</pre>

<pre class="lang:js decode:true">{
        "queryPlanner" : {
                "plannerVersion" : 1,
                "namespace" : "example.mycoll",
                "indexFilterSet" : false,
                "parsedQuery" : {
                        "$and" : [
                                {
                                        "a" : {
                                                "$eq" : 17
                                        }
                                },
                                {
                                        "b" : {
                                                "$eq" : 55
                                        }
                                }
                        ]
                },
                "winningPlan" : {
                        "stage" : "FETCH",
                        "filter" : {
                                "a" : {
                                        "$eq" : 17
                                }
                        },
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "keyPattern" : {
                                        "b" : 1
                                },
                                "indexName" : "b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "b" : [
                                                "[55.0, 55.0]"
                                        ]
                                }
                        }
                },
                "rejectedPlans" : [ ]
        },
        "executionStats" : {
                "executionSuccess" : true,
                "nReturned" : 100,
                "executionTimeMillis" : 24,
                "totalKeysExamined" : 10000,
                "totalDocsExamined" : 10000,
                "executionStages" : {
                        "stage" : "FETCH",
                        "filter" : {
                                "a" : {
                                        "$eq" : 17
                                }
                        },
                        "nReturned" : 100,
                        "executionTimeMillisEstimate" : 20,
                        "works" : 10001,
                        "advanced" : 100,
                        "needTime" : 9900,
                        "needYield" : 0,
                        "saveState" : 78,
                        "restoreState" : 78,
                        "isEOF" : 1,
                        "invalidates" : 0,
                        "docsExamined" : 10000,
                        "alreadyHasObj" : 0,
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "nReturned" : 10000,
                                "executionTimeMillisEstimate" : 0,
                                "works" : 10001,
                                "advanced" : 10000,
                                "needTime" : 0,
                                "needYield" : 0,
                                "saveState" : 78,
                                "restoreState" : 78,
                                "isEOF" : 1,
                                "invalidates" : 0,
                                "keyPattern" : {
                                        "b" : 1
                                },
                                "indexName" : "b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "b" : [
                                                "[55.0, 55.0]"
                                        ]
                                },
                                "keysExamined" : 10000,
                                "dupsTested" : 0,
                                "dupsDropped" : 0,
                                "seenInvalidated" : 0
                        }
                }
        },
        "serverInfo" : {
                "host" : "BLUEONE",
                "port" : 27017,
                "version" : "3.2.0",
                "gitVersion" : "45d947729a0315accb6d4f15a6b06be6d9c19fe7"
        },
        "ok" : 1
}</pre>

<p style="text-align: justify;">
  We see <strong>executionTimeMillis </strong>= 24ms, <strong>totalKeysExamined</strong> and <strong>totalDocsExamined</strong> but also the <strong>executionStages</strong>.
</p>

<p style="text-align: justify;">
  <tt class="docutils literal"><span class="pre"><strong>allPlansExecution</strong> - like <strong>executionStats</strong> but runs each available plan and <tt>returns the stats for each one.<tt></tt></tt> </span></tt>
</p>

<pre class="lang:js decode:true ">db.mycoll.explain("allPlansExecution").find({a:14,b:12})
{
        "queryPlanner" : {
                "plannerVersion" : 1,
                "namespace" : "example.mycoll",
                "indexFilterSet" : false,
                "parsedQuery" : {
                        "$and" : [
                                {
                                        "a" : {
                                                "$eq" : 14
                                        }
                                },
                                {
                                        "b" : {
                                                "$eq" : 12
                                        }
                                }
                        ]
                },
                "winningPlan" : {
                        "stage" : "FETCH",
                        "filter" : {
                                "a" : {
                                        "$eq" : 14
                                }
                        },
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "keyPattern" : {
                                        "b" : 1
                                },
                                "indexName" : "b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "b" : [
                                                "[12.0, 12.0]"
                                        ]
                                }
                        }
                },
                "rejectedPlans" : [ ]
        },
        "executionStats" : {
                "executionSuccess" : true,
                "nReturned" : 100,
                "executionTimeMillis" : 25,
                "totalKeysExamined" : 10000,
                "totalDocsExamined" : 10000,
                "executionStages" : {
                        "stage" : "FETCH",
                        "filter" : {
                                "a" : {
                                        "$eq" : 14
                                }
                        },
                        "nReturned" : 100,
                        "executionTimeMillisEstimate" : 30,
                        "works" : 10001,
                        "advanced" : 100,
                        "needTime" : 9900,
                        "needYield" : 0,
                        "saveState" : 78,
                        "restoreState" : 78,
                        "isEOF" : 1,
                        "invalidates" : 0,
                        "docsExamined" : 10000,
                        "alreadyHasObj" : 0,
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "nReturned" : 10000,
                                "executionTimeMillisEstimate" : 10,
                                "works" : 10001,
                                "advanced" : 10000,
                                "needTime" : 0,
                                "needYield" : 0,
                                "saveState" : 78,
                                "restoreState" : 78,
                                "isEOF" : 1,
                                "invalidates" : 0,
                                "keyPattern" : {
                                        "b" : 1
                                },
                                "indexName" : "b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "b" : [
                                                "[12.0, 12.0]"
                                        ]
                                },
                                "keysExamined" : 10000,
                                "dupsTested" : 0,
                                "dupsDropped" : 0,
                                "seenInvalidated" : 0
                        }
                },
                "allPlansExecution" : [ ]
        },
        "serverInfo" : {
                "host" : "BLUEONE",
                "port" : 27017,
                "version" : "3.2.0",
                "gitVersion" : "45d947729a0315accb6d4f15a6b06be6d9c19fe7"
        },
        "ok" : 1
}</pre>

<pre class="lang:js decode:true ">db.mycoll.createIndex({a:1, b:1}) -- make sure we have 2 indexes
db.mycoll.createIndex({b:1})
db.mycoll.explain("allPlansExecution").find({a:14,b:12})
</pre>

The output will show all available execution plans with the stats:

<pre class="lang:js decode:true">{
        "queryPlanner" : {
                "plannerVersion" : 1,
                "namespace" : "example.mycoll",
                "indexFilterSet" : false,
                "parsedQuery" : {
                        "$and" : [
                                {
                                        "a" : {
                                                "$eq" : 14
                                        }
                                },
                                {
                                        "b" : {
                                                "$eq" : 12
                                        }
                                }
                        ]
                },
                "winningPlan" : {
                        "stage" : "FETCH",
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "keyPattern" : {
                                        "a" : 1,
                                        "b" : 1
                                },
                                "indexName" : "a_1_b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "a" : [
                                                "[14.0, 14.0]"
                                        ],
                                        "b" : [
                                                "[12.0, 12.0]"
                                        ]
                                }
                        }
                },
                "rejectedPlans" : [
                        {
                                "stage" : "FETCH",
                                "filter" : {
                                        "a" : {
                                                "$eq" : 14
                                        }
                                },
                                "inputStage" : {
                                        "stage" : "IXSCAN",
                                        "keyPattern" : {
                                                "b" : 1
                                        },
                                        "indexName" : "b_1",
                                        "isMultiKey" : false,
                                        "isUnique" : false,
                                        "isSparse" : false,
                                        "isPartial" : false,
                                        "indexVersion" : 1,
                                        "direction" : "forward",
                                        "indexBounds" : {
                                                "b" : [
                                                        "[12.0, 12.0]"
                                                ]
                                        }
                                }
                        }
                ]
        },
        "executionStats" : {
                "executionSuccess" : true,
                "nReturned" : 100,
                "executionTimeMillis" : 42,
                "totalKeysExamined" : 100,
                "totalDocsExamined" : 100,
                "executionStages" : {
                        "stage" : "FETCH",
                        "nReturned" : 100,
                        "executionTimeMillisEstimate" : 40,
                        "works" : 102,
                        "advanced" : 100,
                        "needTime" : 0,
                        "needYield" : 0,
                        "saveState" : 3,
                        "restoreState" : 3,
                        "isEOF" : 1,
                        "invalidates" : 0,
                        "docsExamined" : 100,
                        "alreadyHasObj" : 0,
                        "inputStage" : {
                                "stage" : "IXSCAN",
                                "nReturned" : 100,
                                "executionTimeMillisEstimate" : 40,
                                "works" : 101,
                                "advanced" : 100,
                                "needTime" : 0,
                                "needYield" : 0,
                                "saveState" : 3,
                                "restoreState" : 3,
                                "isEOF" : 1,
                                "invalidates" : 0,
                                "keyPattern" : {
                                        "a" : 1,
                                        "b" : 1
                                },
                                "indexName" : "a_1_b_1",
                                "isMultiKey" : false,
                                "isUnique" : false,
                                "isSparse" : false,
                                "isPartial" : false,
                                "indexVersion" : 1,
                                "direction" : "forward",
                                "indexBounds" : {
                                        "a" : [
                                                "[14.0, 14.0]"
                                        ],
                                        "b" : [
                                                "[12.0, 12.0]"
                                        ]
                                },
                                "keysExamined" : 100,
                                "dupsTested" : 0,
                                "dupsDropped" : 0,
                                "seenInvalidated" : 0
                        }
                },
                "allPlansExecution" : [
                        {
                                "nReturned" : 0,
                                "executionTimeMillisEstimate" : 0,
                                "totalKeysExamined" : 101,
                                "totalDocsExamined" : 101,
                                "executionStages" : {
                                        "stage" : "FETCH",
                                        "filter" : {
                                                "a" : {
                                                        "$eq" : 14
                                                }
                                        },
                                        "nReturned" : 0,
                                        "executionTimeMillisEstimate" : 0,
                                        "works" : 101,
                                        "advanced" : 0,
                                        "needTime" : 101,
                                        "needYield" : 0,
                                        "saveState" : 3,
                                        "restoreState" : 3,
                                        "isEOF" : 0,
                                        "invalidates" : 0,
                                        "docsExamined" : 101,
                                        "alreadyHasObj" : 0,
                                        "inputStage" : {
                                                "stage" : "IXSCAN",
                                                "nReturned" : 101,
                                                "executionTimeMillisEstimate" : 0,
                                                "works" : 101,
                                                "advanced" : 101,
                                                "needTime" : 0,
                                                "needYield" : 0,
                                                "saveState" : 3,
                                                "restoreState" : 3,
                                                "isEOF" : 0,
                                                "invalidates" : 0,
                                                "keyPattern" : {
                                                        "b" : 1
                                                },
                                                "indexName" : "b_1",
                                                "isMultiKey" : false,
                                                "isUnique" : false,
                                                "isSparse" : false,
                                                "isPartial" : false,
                                                "indexVersion" : 1,
                                                "direction" : "forward",
                                                "indexBounds" : {
                                                        "b" : [
                                                                "[12.0, 12.0]"
                                                        ]
                                                },
                                                "keysExamined" : 101,
                                                "dupsTested" : 0,
                                                "dupsDropped" : 0,
                                                "seenInvalidated" : 0
                                        }
                                }
                        },
                        {
                                "nReturned" : 100,
                                "executionTimeMillisEstimate" : 40,
                                "totalKeysExamined" : 100,
                                "totalDocsExamined" : 100,
                                "executionStages" : {
                                        "stage" : "FETCH",
                                        "nReturned" : 100,
                                        "executionTimeMillisEstimate" : 40,
                                        "works" : 101,
                                        "advanced" : 100,
                                        "needTime" : 0,
                                        "needYield" : 0,
                                        "saveState" : 2,
                                        "restoreState" : 2,
                                        "isEOF" : 1,
                                        "invalidates" : 0,
                                        "docsExamined" : 100,
                                        "alreadyHasObj" : 0,
                                        "inputStage" : {
                                                "stage" : "IXSCAN",
                                                "nReturned" : 100,
                                                "executionTimeMillisEstimate" : 40,
                                                "works" : 101,
                                                "advanced" : 100,
                                                "needTime" : 0,
                                                "needYield" : 0,
                                                "saveState" : 2,
                                                "restoreState" : 2,
                                                "isEOF" : 1,
                                                "invalidates" : 0,
                                                "keyPattern" : {
                                                        "a" : 1,
                                                        "b" : 1
                                                },
                                                "indexName" : "a_1_b_1",
                                                "isMultiKey" : false,
                                                "isUnique" : false,
                                                "isSparse" : false,
                                                "isPartial" : false,
                                                "indexVersion" : 1,
                                                "direction" : "forward",
                                                "indexBounds" : {
                                                        "a" : [
                                                                "[14.0, 14.0]"
                                                        ],
                                                        "b" : [
                                                                "[12.0, 12.0]"
                                                        ]
                                                },
                                                "keysExamined" : 100,
                                                "dupsTested" : 0,
                                                "dupsDropped" : 0,
                                                "seenInvalidated" : 0
                                        }
                                }
                        }
                ]
        },
        "serverInfo" : {
                "host" : "BLUEONE",
                "port" : 27017,
                "version" : "3.2.0",
                "gitVersion" : "45d947729a0315accb6d4f15a6b06be6d9c19fe7"
        },
        "ok" : 1
}</pre>

If you look on allPlansExecution, the first plan returned nReturned = 0 documents and was stopped because it was overruled by secondPlan that was already finished.

## $hint

<h6 style="text-align: justify;">
  Indexes are automatically used by mongoDB when performing queries (apart from using <a href="https://docs.mongodb.org/manual/core/index-sparse/" target="_blank">sparse </a>index). The <b>$hint</b> operator forces the query optimizer to use the specified index to run a query. This is useful when you want to test performance of a query with different indexes.
</h6>

<pre class="lang:js decode:true">db.studentsInfoCollection.find({"name.firstName":"Doina"}).hint({"name.firstName":"Doina"}).explain("executionStats");</pre>

<h2 style="text-align: justify;">
  Covered queries
</h2>

As per the official MongoDB documentation, a covered query is a query in which:

<ul class="list">
  <li>
    all the fields in the query are part of an index and
  </li>
  <li>
    all the fields returned in the query are in the same index
  </li>
</ul>

<p style="text-align: justify;">
  Since all the fields present in the query are part of an index, MongoDB matches the query conditions and returns the result using the same index without actually looking inside documents. Since indexes are present in RAM, fetching data from indexes is much faster as compared to fetching data by scanning documents.
</p>

<p style="text-align: justify;">
  Selectivity is the primary factor that determines how efficiently an index can be used. Ideally, the index enables us to select only those records required to complete the result set, without the need to scan a substantially larger number of index keys (or documents) in order to complete the query. Selectivity determines how many records any subsequent operations must work with. Fewer records means less execution time.
</p>

<h2 style="text-align: justify;">
  MongoDB Index types
</h2>

<p style="text-align: justify;">
  In MongoDB there are few index types:
</p>

<a href="https://docs.mongodb.org/manual/core/index-sparse/" target="_blank">Sparse index</a> is useful in case of rare fields. Sparse indexes only contain entries for documents that have the indexed field, even if the index field contains a null value. The index skips over any document that is missing the indexed field.

<a href="https://docs.mongodb.org/manual/core/index-ttl/" target="_blank">TTL index</a> &#8211; MongoDB is using to automatically remove documents from a collection after a certain amount of time.

<pre class="lang:js decode:true ">db.eventlog.createIndex({"lastModifiedDate":1}, {expireAfterSeconds:3600})</pre>

<p style="text-align: justify;">
  No TTL indexed document will be deleted before the <strong>expireAfterSeconds</strong> is passed since the last update in that document.
</p>

<p style="text-align: justify;">
  <a href="https://docs.mongodb.org/manual/applications/geospatial-indexes/" target="_blank">Geospatial index</a> &#8211; supports only 2d dimensions (eg: locations: [longitude, latitude]).
</p>

<pre class="lang:js decode:true">db.places.insert({"loc":[3,2]})
db.places.insert({"loc":[2,4]})
db.places.insert({"loc":[5,7]})
db.places.insert({"loc":[2,4]})
db.places.insert({"loc":[32,-30]})

db.places.createIndex({"loc" : "2dsphere"})

db.places.find({loc:
    {$near: {$geometry:
              {type: "Point", coordinates: [3, 3.2]},
              spherical:true
         }
    }
})</pre>

<a href="https://docs.mongodb.org/manual/core/index-text/" target="_blank">Text indexes</a> &#8211; the field you want to index must be a text.

<pre class="lang:js decode:true">db.ticketMessages.createIndex( { body: "text" } )
db.ticketMessages.find({$text: {$search: "agent name"}}) -- messages containing either agent or name
db.ticketMessages.find({$text: {$search: "agent name"}}, {score:{$meta:"textScore"}})
</pre>

&nbsp;

Additional links:

  1. <a href="https://docs.mongodb.org/manual/reference/method/db.collection.createIndex/" target="_blank">https://docs.mongodb.org/manual/reference/method/db.collection.createIndex/</a>
  2. <a href="http://geojson.org/" target="_blank">http://geojson.org/</a>